# Claude Code Guidelines

This document helps Claude Code work effectively with this Raspberry Pi kiosk dashboard project.

## Project Overview

A Raspberry Pi-based kiosk running a Chromium browser in fullscreen mode to display a Home Assistant dashboard for family chore management.

**What's Working:**
- `scripts/kiosk.sh` - Launches Chromium in kiosk mode on boot
- `scripts/touchscreen-check.sh` - Automatic touchscreen recovery via soft reboot
- `scripts/mqtt_listener.py` - MQTT subscriber for Home Assistant display control
- `scripts/display_control.py` - HDMI display power control
- `config/autostart/kiosk.desktop` - Template for autostart configuration
- `config/systemd/touchscreen-check.service` - Systemd service for touchscreen auto-recovery
- `config/systemd/mqtt-listener.service` - Systemd service for MQTT display control
- `config/mqtt.json` - MQTT broker configuration (generated by bootstrap)
- `scripts/setup/bootstrap.sh` - Automated provisioning script
- `scripts/setup/verify.sh` - Post-setup verification script
- Git version control with clear commit history

## Project Structure

```
~/dashboard-project/
├── scripts/
│   ├── kiosk.sh                # Browser startup script (core functionality)
│   ├── touchscreen-check.sh    # Touchscreen detection and auto-reboot logic
│   ├── mqtt_listener.py        # MQTT subscriber daemon for display control
│   ├── display_control.py      # Display power control (called by MQTT listener)
│   └── setup/
│       ├── bootstrap.sh        # Automated provisioning
│       └── verify.sh           # Post-setup checks
├── config/
│   ├── autostart/
│   │   └── kiosk.desktop       # Autostart template (uses __REPO_ROOT__ token)
│   ├── systemd/
│   │   ├── touchscreen-check.service  # Systemd service template
│   │   └── mqtt-listener.service      # MQTT listener service template
│   ├── mqtt.json.template      # MQTT configuration template
│   └── mqtt.json               # MQTT configuration (created by bootstrap)
├── readme.md                   # User-facing documentation
└── CLAUDE.md                  # This file
```

## Key Commands

### Setup & Provisioning
```bash
# Run after cloning to a fresh Pi
./scripts/setup/bootstrap.sh

# Verify everything is configured correctly
./scripts/setup/verify.sh
```

### Kiosk Control
```bash
# Test kiosk mode manually
./scripts/kiosk.sh

# Stop kiosk mode (via SSH)
pkill chromium
```

### Touchscreen Service Management
```bash
# Check service status
systemctl status touchscreen-check.service

# View logs
journalctl -u touchscreen-check.service -f

# Disable/enable service
sudo systemctl disable touchscreen-check.service
sudo systemctl enable touchscreen-check.service

# Manual test (not recommended - will reboot if touchscreen missing)
./scripts/touchscreen-check.sh
```

**How It Works:**
- Runs once at boot after 60-second hardware stabilization
- Detects touchscreen via USB ID `222a:0001`
- Uses flag file `/var/run/touchscreen-reboot-attempted` for boot loop protection
- Flag persists across soft reboots but cleared on power cycles
- Performs ONE automatic reboot if touchscreen missing, then stops

### MQTT Display Control
```bash
# Check MQTT listener service status
systemctl status mqtt-listener.service

# View MQTT listener logs
journalctl -u mqtt-listener.service -f

# Start/stop/restart service
sudo systemctl start mqtt-listener.service
sudo systemctl stop mqtt-listener.service
sudo systemctl restart mqtt-listener.service

# Manual display control (bypassing MQTT)
python3 scripts/display_control.py on
python3 scripts/display_control.py off
python3 scripts/display_control.py status
```

**MQTT Topics:**
- Command: `dashboard/display/command` (accepts: `on`, `off`, `status`)
- Status: `dashboard/display/status` (publishes: `on`, `off`, `unknown`)
- Availability: `dashboard/display/availability` (publishes: `online`, `offline`)

**How It Works:**
- `mqtt_listener.py` runs as a systemd service
- Connects to MQTT broker configured in `config/mqtt.json`
- Subscribes to command topic and listens for messages from Home Assistant
- Executes `display_control.py` when commands received
- Publishes status updates back to Home Assistant
- Handles reconnection automatically on network issues
- Uses MQTT Last Will and Testament for availability tracking

## Coding Conventions

### Shell Scripts
- Use `bash` with `set -euo pipefail`
- Two-space indentation
- Quote all variables
- Keep functions small with descriptive verb names
- Lowercase filenames with hyphens (`kiosk.desktop`, `bootstrap.sh`)

### Python Scripts
- Type hints where applicable
- Descriptive function and variable names
- Standard library preferred over external dependencies

### Templates
- Preserve `__REPO_ROOT__` token in templates
- Bootstrap script renders these during setup

## Testing & Verification

- `verify.sh` is the central smoke test
- Extend it when adding new dependencies
- Document manual verification steps for hardware features (touchscreen, GPIO, display power)

## Git Workflow

### Commit Messages
- Present tense, concise subject lines under 70 characters
- Example: `sync autostart template`
- Group logical changes per commit
- Describe observable behavior in commit body when needed

### What to Track
- Configuration files and templates
- Scripts and automation
- Documentation

### What NOT to Track (see .gitignore)
- Python cache (`__pycache__/`, `*.pyc`)
- Editor files (`*.swp`, `.vscode/`, `.idea/`)
- OS artifacts (`.DS_Store`)

## Important Notes

### Security
- Never hard-code secrets, IPs, or dashboard URLs beyond documented placeholders
- Use environment variables or template tokens instead
- `config/mqtt.json` contains MQTT credentials and is excluded from git via `.gitignore`
- `config/mqtt.json.template` uses `__MQTT_*__` placeholder tokens
- Bootstrap script prompts for MQTT credentials and renders template

### Future Features Planned
- Additional Home Assistant automations as needed
- Potential GPIO sensor integration

### Bootstrap Recovery
- Re-run `bootstrap.sh` after OS updates or Pi rebuilds
- Ensures permissions and autostart files remain current
- Designed for quick recovery from failures
